name: Build & Release

on:
  push:
    tags:
      - 'v*'
  schedule:
    - cron: '0 4 * * *'  # Daily at 4 AM UTC
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - release

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config \
            libsdl2-dev \
            p7zip-full unzip zip curl wget \
            libx11-dev libssl-dev \
            bubblewrap fuse-overlayfs slirp4netns \
            fuse libfuse2 file patchelf

      - name: Install Rust
        run: |
          if ! command -v cargo &> /dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          fi
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: splitux-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: splitux-cargo-

      - name: Cache external deps
        id: deps-cache
        uses: actions/cache@v4
        with:
          path: /tmp/deps-cache
          key: splitux-deps-v2

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_NAME="Splitux ${VERSION}"
            IS_NIGHTLY="false"
          else
            VERSION="nightly"
            RELEASE_NAME="Splitux Nightly ($(date +%Y-%m-%d))"
            IS_NIGHTLY="true"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is_nightly=$IS_NIGHTLY" >> $GITHUB_OUTPUT

      - name: Fetch dependencies
        run: |
          mkdir -p res/goldberg res/gamescope-splitux res/bepinex res/facepunch
          CACHE_DIR="/tmp/deps-cache"
          mkdir -p "$CACHE_DIR"

          # Gamescope-splitux (cached - stable version)
          if [ -f "$CACHE_DIR/gamescope-splitux-v1.0.0.zip" ]; then
            echo "Using cached gamescope-splitux"
            unzip -o -q "$CACHE_DIR/gamescope-splitux-v1.0.0.zip" -d res/gamescope-splitux
          else
            curl -fsSL https://github.com/gabrielgad/gamescope-splitux/releases/download/v1.0.0/gamescope-splitux-v1.0.0.zip -o "$CACHE_DIR/gamescope-splitux-v1.0.0.zip"
            unzip -o -q "$CACHE_DIR/gamescope-splitux-v1.0.0.zip" -d res/gamescope-splitux
          fi

          # Goldberg (always fresh - nightly builds)
          curl -fsSL https://github.com/gabrielgad/gbe_fork-splitux/releases/download/nightly/emu-linux-release.tar.bz2 -o /tmp/gbe-linux.tar.bz2
          tar -xjf /tmp/gbe-linux.tar.bz2 -C /tmp
          mkdir -p res/goldberg/{linux64,linux32,win,steamnetworkingsockets/x64,steamnetworkingsockets/x32}
          cp -f /tmp/release/regular/x64/*.so res/goldberg/linux64/ 2>/dev/null || true
          cp -f /tmp/release/regular/x32/*.so res/goldberg/linux32/ 2>/dev/null || true

          curl -fsSL https://github.com/gabrielgad/gbe_fork-splitux/releases/download/nightly/emu-win-release.7z -o /tmp/gbe-win.7z
          7z x -o/tmp/gbe-win /tmp/gbe-win.7z -y
          cp -f /tmp/gbe-win/release/regular/steam_api64.dll res/goldberg/win/ 2>/dev/null || true
          cp -f /tmp/gbe-win/release/regular/steam_api.dll res/goldberg/win/ 2>/dev/null || true
          cp -f /tmp/gbe-win/release/steamnetworkingsockets/x64/*.dll res/goldberg/steamnetworkingsockets/x64/ 2>/dev/null || true
          cp -f /tmp/gbe-win/release/steamnetworkingsockets/x32/*.dll res/goldberg/steamnetworkingsockets/x32/ 2>/dev/null || true

          # BepInEx 5 Mono Windows (cached)
          if [ -f "$CACHE_DIR/BepInEx_win_x64_5.4.23.2.zip" ]; then
            echo "Using cached BepInEx Mono Windows"
            cp "$CACHE_DIR/BepInEx_win_x64_5.4.23.2.zip" /tmp/bepinex-mono.zip
          else
            curl -fsSL https://github.com/BepInEx/BepInEx/releases/download/v5.4.23.2/BepInEx_win_x64_5.4.23.2.zip -o /tmp/bepinex-mono.zip
            cp /tmp/bepinex-mono.zip "$CACHE_DIR/BepInEx_win_x64_5.4.23.2.zip"
          fi
          mkdir -p res/bepinex/mono/core
          unzip -q /tmp/bepinex-mono.zip -d /tmp/bepinex-mono
          cp -f /tmp/bepinex-mono/BepInEx/core/* res/bepinex/mono/core/ 2>/dev/null || true
          cp -f /tmp/bepinex-mono/winhttp.dll res/bepinex/mono/ 2>/dev/null || true
          cp -f /tmp/bepinex-mono/doorstop_config.ini res/bepinex/mono/ 2>/dev/null || true

          # BepInEx 5 Mono Linux (cached)
          if [ -f "$CACHE_DIR/BepInEx_linux_x64_5.4.23.2.zip" ]; then
            echo "Using cached BepInEx Mono Linux"
            cp "$CACHE_DIR/BepInEx_linux_x64_5.4.23.2.zip" /tmp/bepinex-mono-linux.zip
          else
            curl -fsSL https://github.com/BepInEx/BepInEx/releases/download/v5.4.23.2/BepInEx_linux_x64_5.4.23.2.zip -o /tmp/bepinex-mono-linux.zip
            cp /tmp/bepinex-mono-linux.zip "$CACHE_DIR/BepInEx_linux_x64_5.4.23.2.zip"
          fi
          mkdir -p res/bepinex/mono-linux/core
          unzip -q /tmp/bepinex-mono-linux.zip -d /tmp/bepinex-mono-linux
          cp -f /tmp/bepinex-mono-linux/BepInEx/core/* res/bepinex/mono-linux/core/ 2>/dev/null || true
          cp -f /tmp/bepinex-mono-linux/libdoorstop.so res/bepinex/mono-linux/ 2>/dev/null || true
          cp -f /tmp/bepinex-mono-linux/run_bepinex.sh res/bepinex/mono-linux/ 2>/dev/null || true

          # BepInEx 6 IL2CPP (cached)
          if [ -f "$CACHE_DIR/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip" ]; then
            echo "Using cached BepInEx IL2CPP"
            cp "$CACHE_DIR/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip" /tmp/bepinex-il2cpp.zip
          else
            curl -fsSL https://github.com/BepInEx/BepInEx/releases/download/v6.0.0-pre.2/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip -o /tmp/bepinex-il2cpp.zip
            cp /tmp/bepinex-il2cpp.zip "$CACHE_DIR/BepInEx-Unity.IL2CPP-win-x64-6.0.0-pre.2.zip"
          fi
          mkdir -p res/bepinex/il2cpp/core
          unzip -q /tmp/bepinex-il2cpp.zip -d /tmp/bepinex-il2cpp
          cp -f /tmp/bepinex-il2cpp/BepInEx/core/* res/bepinex/il2cpp/core/ 2>/dev/null || true
          cp -f /tmp/bepinex-il2cpp/winhttp.dll res/bepinex/il2cpp/ 2>/dev/null || true
          cp -f /tmp/bepinex-il2cpp/doorstop_config.ini res/bepinex/il2cpp/ 2>/dev/null || true

          # SplituxFacepunch (cached)
          if [ -f "$CACHE_DIR/SplituxFacepunch-v2.1.0.dll" ]; then
            echo "Using cached SplituxFacepunch"
            cp "$CACHE_DIR/SplituxFacepunch-v2.1.0.dll" res/facepunch/SplituxFacepunch.dll
          else
            curl -fsSL https://github.com/splitux-gg/bepinex-facepunch-splitux/releases/download/v2.1.0/SplituxFacepunch.dll -o res/facepunch/SplituxFacepunch.dll
            cp res/facepunch/SplituxFacepunch.dll "$CACHE_DIR/SplituxFacepunch-v2.1.0.dll"
          fi

      - name: Build Splitux
        run: |
          cargo build --release

      - name: Package tarball
        run: |
          mkdir -p release/splitux/bin release/splitux/res

          # Copy binary
          cp target/release/splitux release/splitux/
          chmod +x release/splitux/splitux

          # Copy gamescope-splitux
          cp res/gamescope-splitux/bin/* release/splitux/bin/
          chmod +x release/splitux/bin/*

          # Copy resources
          cp -r res/* release/splitux/res/
          cp LICENSE release/splitux/ 2>/dev/null || true

          # Copy scripts and desktop file
          cp launch.sh release/splitux/
          cp install.sh release/splitux/
          cp splitux.sh release/splitux/
          cp splitux.desktop release/splitux/
          chmod +x release/splitux/launch.sh release/splitux/install.sh release/splitux/splitux.sh

          # Create tarball
          cd release
          tar -czvf splitux-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz splitux/

          # Create zip archive
          zip -r splitux-${{ steps.version.outputs.version }}-linux-x86_64.zip splitux/

      - name: Build AppImage
        run: |
          # Download appimagetool
          curl -fsSL https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage -o /tmp/appimagetool
          chmod +x /tmp/appimagetool

          # Create AppDir structure
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps AppDir/usr/share/splitux

          # Copy binary and resources
          cp target/release/splitux AppDir/usr/bin/
          cp -r res/* AppDir/usr/share/splitux/
          cp res/gamescope-splitux/bin/* AppDir/usr/bin/
          chmod +x AppDir/usr/bin/*

          # Create desktop file
          cat > AppDir/usr/share/applications/splitux.desktop << 'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=Splitux
          Comment=Local split-screen multiplayer for Steam games
          Exec=splitux
          Icon=splitux
          Categories=Game;
          Terminal=false
          DESKTOP

          # Copy/create icon (use a placeholder if none exists)
          if [ -f res/icon.png ]; then
            cp res/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/splitux.png
          else
            # Create a simple placeholder icon
            echo "No icon found, AppImage will use default"
          fi

          # Create AppRun script
          cat > AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export XDG_DATA_DIRS="${HERE}/usr/share:${XDG_DATA_DIRS}"
          export SPLITUX_RES_PATH="${HERE}/usr/share/splitux"
          exec "${HERE}/usr/bin/splitux" "$@"
          APPRUN
          chmod +x AppDir/AppRun

          # Symlinks for AppImage
          ln -sf usr/share/applications/splitux.desktop AppDir/splitux.desktop
          ln -sf usr/share/icons/hicolor/256x256/apps/splitux.png AppDir/splitux.png 2>/dev/null || true

          # Build AppImage (extract and run since FUSE may not work in container)
          /tmp/appimagetool --appimage-extract
          ARCH=x86_64 ./squashfs-root/AppRun AppDir release/Splitux-${{ steps.version.outputs.version }}-x86_64.AppImage

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-linux-x86_64-tarball
          path: release/splitux-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-linux-x86_64-zip
          path: release/splitux-${{ steps.version.outputs.version }}-linux-x86_64.zip

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-x86_64-AppImage
          path: release/Splitux-${{ steps.version.outputs.version }}-x86_64.AppImage

  build-flatpak:
    runs-on: [self-hosted, Linux, X64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="nightly"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache Flatpak
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/flatpak
            .flatpak-builder
          key: splitux-flatpak-${{ hashFiles('Cargo.lock') }}
          restore-keys: splitux-flatpak-

      - name: Install Flatpak SDK
        run: |
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          # Install SDK if not already present
          if ! flatpak info --user org.freedesktop.Sdk//23.08 &>/dev/null; then
            flatpak install --user -y flathub org.freedesktop.Platform//23.08 org.freedesktop.Sdk//23.08
          fi

      - name: Build Flatpak
        run: |
          # Create flatpak manifest
          cat > gg.splitux.Splitux.yml << 'MANIFEST'
          app-id: gg.splitux.Splitux
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          command: splitux
          finish-args:
            - --share=ipc
            - --share=network
            - --socket=x11
            - --socket=wayland
            - --socket=pulseaudio
            - --device=all
            - --filesystem=home
            - --filesystem=/run/media
            - --filesystem=/media
            - --filesystem=/mnt
            - --filesystem=xdg-run/gamescope-0:create
            - --talk-name=org.freedesktop.Flatpak
            - --env=PATH=/app/bin:/usr/bin
          modules:
            - name: bubblewrap
              buildsystem: meson
              sources:
                - type: archive
                  url: https://github.com/containers/bubblewrap/releases/download/v0.8.0/bubblewrap-0.8.0.tar.xz
                  sha256: 957ad1149db9033db88e988b12bcebe349a445e1efc8a9b59ad2939a113d333a

            - name: fuse-overlayfs
              buildsystem: simple
              build-commands:
                - install -Dm755 fuse-overlayfs /app/bin/fuse-overlayfs
              sources:
                - type: file
                  url: https://github.com/containers/fuse-overlayfs/releases/download/v1.14/fuse-overlayfs-x86_64
                  sha256: 4817a8896a9e6f0433080f88f5b71dec931e8829a89d64c71af94b0630ccb4a9
                  dest-filename: fuse-overlayfs

            - name: splitux
              buildsystem: simple
              build-options:
                build-args:
                  - --share=network
                env:
                  CARGO_HOME: /run/build/splitux/cargo
                  RUSTUP_HOME: /run/build/splitux/rustup
              build-commands:
                - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal
                - . $CARGO_HOME/env && cargo build --release
                - install -Dm755 target/release/splitux /app/bin/splitux
                - mkdir -p /app/share/splitux
                - cp -r res/* /app/share/splitux/ || true
              sources:
                - type: dir
                  path: .
          MANIFEST

          # Build flatpak (user installation, no sudo needed)
          flatpak-builder --user --force-clean --repo=repo build-dir gg.splitux.Splitux.yml

          # Create single-file bundle
          mkdir -p release
          flatpak build-bundle repo release/Splitux-${{ steps.version.outputs.version }}.flatpak gg.splitux.Splitux

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-flatpak
          path: release/Splitux-${{ steps.version.outputs.version }}.flatpak

  release:
    needs: [build, build-flatpak]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') || github.event_name == 'schedule' || github.event.inputs.release_type != ''

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            RELEASE_NAME="Splitux ${VERSION}"
            IS_NIGHTLY="false"
            PRERELEASE="false"
          else
            VERSION="nightly"
            RELEASE_NAME="Splitux Nightly ($(date +%Y-%m-%d))"
            IS_NIGHTLY="true"
            PRERELEASE="true"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "is_nightly=$IS_NIGHTLY" >> $GITHUB_OUTPUT
          echo "prerelease=$PRERELEASE" >> $GITHUB_OUTPUT

      - name: Download tarball artifact
        uses: actions/download-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-linux-x86_64-tarball

      - name: Download zip artifact
        uses: actions/download-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-linux-x86_64-zip

      - name: Download AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-x86_64-AppImage

      - name: Download Flatpak artifact
        uses: actions/download-artifact@v4
        with:
          name: splitux-${{ steps.version.outputs.version }}-flatpak

      - name: Delete existing nightly release
        if: steps.version.outputs.is_nightly == 'true'
        continue-on-error: true
        run: |
          gh release delete nightly --yes --repo ${{ github.repository }} || true
          git push --delete origin nightly || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.release_name }}
          tag_name: ${{ steps.version.outputs.is_nightly == 'true' && 'nightly' || github.ref_name }}
          prerelease: ${{ steps.version.outputs.prerelease }}
          generate_release_notes: ${{ steps.version.outputs.is_nightly != 'true' }}
          body: |
            ${{ steps.version.outputs.is_nightly == 'true' && 'Automated nightly build. May be unstable.' || '' }}

            ## Downloads

            | Format | Description |
            |--------|-------------|
            | `.tar.gz` | Native Linux tarball (recommended for most users) |
            | `.zip` | Zip archive |
            | `.AppImage` | Portable AppImage (no installation required) |
            | `.flatpak` | Flatpak bundle (sandboxed) |

            ### Installation

            **Tarball/Zip:**
            ```bash
            tar -xzf splitux-*.tar.gz
            cd splitux
            ./install.sh
            ```

            **AppImage:**
            ```bash
            chmod +x Splitux-*.AppImage
            ./Splitux-*.AppImage
            ```

            **Flatpak:**
            ```bash
            flatpak install Splitux-*.flatpak
            flatpak run gg.splitux.Splitux
            ```
          files: |
            splitux-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
            splitux-${{ steps.version.outputs.version }}-linux-x86_64.zip
            Splitux-${{ steps.version.outputs.version }}-x86_64.AppImage
            Splitux-${{ steps.version.outputs.version }}.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
